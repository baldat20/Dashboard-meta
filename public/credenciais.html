<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Credenciais da Equipe</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Montserrat;
  background:linear-gradient(135deg,#428bfc,#b9e2ff);
}

header{
  background:#000;
  color:#fff;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

h1{margin:0}

.container{
  max-width:1100px;
  margin:30px auto;
}

.card{
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
}

.top-actions{
  padding:16px;
  background:#f4f8ff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.search{
  padding:10px 14px;
  border-radius:8px;
  border:1px solid #ccc;
  width:260px;
  font-size:14px;
}

table{
  width:100%;
  border-collapse:collapse;
}

thead{
  background:#42a7f5;
  color:white;
}

th,td{
  padding:16px;
  text-align:left;
}

tbody tr:nth-child(even){
  background:#f7fbff;
}

.copy{
  background:#42a7f5;
  border:none;
  padding:6px 12px;
  color:white;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}

.show{
  background:#222;
  border:none;
  padding:6px 12px;
  color:white;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}

.trocar{
  background:#ff9800;
  border:none;
  padding:6px 12px;
  color:white;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
</style>

</head>

<body>

<header>
  <h1>Credenciais da Equipe</h1>

  <div style="display:flex; gap:10px; align-items:center;">

<button onclick="voltarPainel()" style="
  background:#42a7f5;
  border:none;
  color:white;
  padding:10px 18px;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;">
  ‚Üê Voltar ao Painel
</button>

<button onclick="trocarMinhaSenha()" style="
  background:#ff9800;
  border:none;
  color:white;
  padding:10px 18px;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;">
  Alterar minha senha
</button>

<div id="nomeSup"></div>
```

  </div>
</header>

<div class="container">
  <div class="card">

```
<div class="top-actions">
  <strong>Lista de acessos</strong>
  <input class="search" id="busca" placeholder="Buscar por nome...">
</div>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Login</th>
      <th>Senha</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="lista"></tbody>
</table>
```

  </div>
</div>

<script>
// =============================
const urlParams = new URLSearchParams(window.location.search);
const nome = urlParams.get("nome");
const cargo = urlParams.get("cargo");

if(!nome || !cargo){
  window.location.href="index.html";
}

document.getElementById("nomeSup").innerText = nome;

let dadosGlobais=[];

// =============================
// CARREGAR
// =============================
async function carregar(){

  const tbody=document.getElementById("lista");
  tbody.innerHTML=`<tr><td colspan="4">Carregando...</td></tr>`;

  try{

    let todos=[];

    // COORD
    if(cargo === "Leticia Caroline Da Silva"){

      const resp = await fetch(`/api/gestao?cargo=${encodeURIComponent(cargo)}`);
      const data = await resp.json();

      Object.values(data.supervisores || {}).forEach(sup=>{
        todos.push(...(sup.analistas || []));
        todos.push(...(sup.auxiliares || []));
      });

    }else{

      const resp1 = await fetch(`/api/gestao?tipo=analistas&supervisao=${encodeURIComponent(nome)}&cargo=${encodeURIComponent(nome)}`);
      const data1 = await resp1.json();
      const analistas = data1.analistas || [];

      const resp2 = await fetch(`/api/gestao?tipo=auxiliares&supervisao=${encodeURIComponent(nome)}&cargo=${encodeURIComponent(nome)}`);
      const data2 = await resp2.json();
      const auxiliares = data2.auxiliares || [];

      todos=[...analistas,...auxiliares];
    }

    dadosGlobais = todos;
    render(dadosGlobais);

  }catch(e){
    tbody.innerHTML=`<tr><td colspan="4">Erro ao carregar</td></tr>`;
  }
}

// =============================
function render(lista){

  const tbody=document.getElementById("lista");
  tbody.innerHTML="";

  if(lista.length===0){
    tbody.innerHTML=`<tr><td colspan="4">Nenhum encontrado</td></tr>`;
    return;
  }

  lista.forEach((p,i)=>{

    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td><strong>${p.nome}</strong></td>
      <td>${p.login||"-"}</td>
      <td id="senha${i}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
      <td style="display:flex; gap:6px;">
        <button class="show" onclick="toggleSenha(${i},'${p.senha}')">üëÅ</button>
        <button class="copy" onclick="copiar('${p.senha}')">üìã</button>
        <button class="trocar" onclick="trocarSenha('${p.nome}')">üîë</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

// =============================
function toggleSenha(i,senha){
  const el=document.getElementById("senha"+i);
  if(el.innerText==="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"){
    el.innerText=senha||"-";
  }else{
    el.innerText="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
  }
}

function copiar(txt){
  navigator.clipboard.writeText(txt||"");
  alert("Senha copiada!");
}

// =============================
// TROCAR SENHA COLABORADOR
// =============================
async function trocarSenha(usuario){

  const nova = prompt("Nova senha para "+usuario);
  if(!nova) return;

  const resp = await fetch("/api/gestao",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      acao:"trocarSenha",
      usuario:usuario,
      solicitante:nome,
      novaSenha:nova
    })
  });

  const data = await resp.json();

  if(data.ok){
    alert("Senha alterada!");
    carregar();
  }else{
    alert(data.erro);
  }
}

// =============================
// MINHA SENHA
// =============================
async function trocarMinhaSenha(){

  const nova = prompt("Digite sua nova senha");
  if(!nova) return;

  const resp = await fetch("/api/gestao",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      acao:"trocarSenha",
      usuario:nome,
      solicitante:nome,
      novaSenha:nova
    })
  });

  const data = await resp.json();

  if(data.ok){
    alert("Senha alterada com sucesso");
  }else{
    alert(data.erro);
  }
}

// =============================
document.getElementById("busca").addEventListener("input",e=>{
  const termo=e.target.value.toLowerCase();
  const filtrado=dadosGlobais.filter(p=>p.nome.toLowerCase().includes(termo));
  render(filtrado);
});

function voltarPainel(){
  window.location.href = `gestao.html?nome=${encodeURIComponent(nome)}&cargo=${encodeURIComponent(cargo)}`;
}

carregar();
</script>

</body>
</html>
